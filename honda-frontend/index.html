<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Master Honda — Spare Parts & Workshop Suite</title>
    <meta name="theme-color" content="#d32f2f" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="Atlas-Honda-logo.jpg" sizes="192x192" />
    <link rel="stylesheet" href="style.css" />

    <!-- Chart.js, jsPDF, XLSX, QR libs (UMD builds) -->
    <!-- third-party libs (UMD builds, no modules needed) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.13/minified/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- your app (as ES modules) -->
    <script type="module" src="./api.js"></script>
    <script>
      window.__API_BASE = "http://localhost:4000/api";
    </script>
    <script>
      window.ADMIN_KEY = window.ADMIN_KEY || "yahya123";
    </script>
    <script type="module" src="./backend.js"></script>
    <script type="module" src="./APP.JS"></script>
  </head>
  <body>
    <button
      id="installPWA"
      style="
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      "
    >
      Install App
    </button>
    <!-- Auth Modal for Role Switch -->

    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="brand">
          <img
            src="Atlas-Honda-logo.jpg"
            alt="Atlas Honda"
            onerror="this.style.display='none'"
          />
          <div>
            <h1>Master Honda</h1>
            <small>Spare Parts & Workshop</small>
          </div>
          <!-- Example in your top bar -->
        </div>

        <nav id="nav">
          <button data-view="dashboard" class="active">Dashboard</button>
          <button data-view="inventory">Inventory</button>
          <button data-view="billing">Billing</button>
          <button data-view="returns">Returns/Refunds</button>
          <button data-view="workshop">Service Jobs</button>
          <button data-view="reports">Reports</button>
        </nav>
        <div
          id="userArea"
          style="
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
          "
        >
          <span id="userBadge" class="badge"></span>
          <button id="logoutBtn" class="ghost">Logout</button>
        </div>
        <footer class="sidebar-footer">
          v1.2 — SPA (LocalStorage)
          <div class="muted">Admin • Agent • Inventory • Service</div>
        </footer>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- Topbar -->
        <header class="topbar">
          <button class="hamburger" id="hamburger" aria-label="Toggle Menu">
            ☰
          </button>
          <input
            id="globalSearch"
            type="search"
            placeholder="Search items, invoices, customers…"
          />
          <div class="right">
            <label class="role">
              Role
              <select id="roleSelect">
                <option value="agent" selected>Agent</option>
                <option value="admin">Admin</option>
                <option value="inventory">Inventory</option>
                <option value="service">Service</option>
              </select>
            </label>
            <button id="manageUsersBtn" class="ghost" style="display:none;margin-left:8px">Manage Users</button>
            <div class="menu">
              <button id="backupBtn" title="Export backup">⭳</button>
              <button id="restoreBtn" title="Import backup">⭱</button>
              <input
                id="restoreFile"
                type="file"
                accept="application/json"
                hidden
              />
            </div>
          </div>
        </header>

        <!-- Dynamic View -->
        <section id="view" class="view"></section>
      </main>
    </div>

    <!-- Inventory Modal -->
    <dialog id="itemModal">
      <form method="dialog" id="itemForm" class="modal">
        <h3 id="itemModalTitle">Add Item</h3>
        <div class="grid2">
          <label> Name <input name="name" required /> </label>
          <label> Code <input name="code" required /> </label>
          <label>
            Qty <input name="qty" type="number" min="0" step="1" required />
          </label>
          <label>
            Low Stock
            <input name="low" type="number" min="0" step="1" value="5" />
          </label>
          <label>
            Purchase
            <input name="buy" type="number" min="0" step="0.01" required />
          </label>
          <label>
            Sell
            <input name="sell" type="number" min="0" step="0.01" required />
          </label>
          <label class="full"> Supplier <input name="supplier" /> </label>
          <label> Barcode/QR <input name="barcode" placeholder="SKU or barcode" /></label>
          <label class="full">
            Description <textarea name="desc" rows="2"></textarea>
          </label>
        </div>
        <menu>
          <button value="cancel" class="ghost">Cancel</button>
          <button value="ok" class="primary">Save</button>
        </menu>
      </form>
    </dialog>

    <!-- Manage Users Modal (admin only) -->
    <dialog id="usersModal">
      <form id="usersForm" class="modal">
        <h3>Manage Users</h3>
        <div>
          <label>Name <input id="newUserName" /></label>
          <label>Role
            <select id="newUserRole">
              <option value="agent">Agent</option>
              <option value="inventory">Inventory</option>
              <option value="service">Service</option>
              <option value="admin">Admin</option>
            </select>
          </label>
          <label>Password <input id="newUserPass" type="password"/></label>
        </div>
        <div style="margin-top:8px">
          <button id="addUserBtn" class="primary">Add User</button>
          <button id="closeUsers" class="ghost">Close</button>
        </div>
        <div id="usersList" style="margin-top:10px"></div>
      </form>
    </dialog>

    <!-- Auth Modal for Role Switch (was missing elements causing cancelBtn undefined) -->
    <dialog id="authModal">
      <form method="dialog" id="authForm" class="modal">
        <h3>Authenticate Role</h3>
        <div class="grid2">
          <label>Username <input id="authUsername" required /></label>
          <label>Password <input id="authPassword" type="password" required /></label>
        </div>
        <div id="authError" style="color:#b91c1c;display:none;margin-top:6px"></div>
        <menu>
          <button id="cancelBtn" value="cancel" class="ghost">Cancel</button>
          <button type="submit" value="ok" class="primary">Login</button>
        </menu>
      </form>
    </dialog>

    <!-- Toast container -->
    <div id="toast"></div>

    <!-- App Logic -->
    <script>
      // Logout button logic
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem('auth.user');
          sessionStorage.clear();
          window.location.href = "login.html";
        });
      }
      // Force login screen on every app load
      (function forceLoginOnLoad() {
        const user = localStorage.getItem('auth.user');
        if (!user) {
          window.location.href = "login.html";
        }
      })();
  // --- Auth for Role Switch ---
  const roleSelect = document.getElementById("roleSelect");
  const authModal = document.getElementById("authModal");
  const authForm = document.getElementById("authForm");
  const authError = document.getElementById("authError");
  const cancelBtn = document.getElementById("cancelBtn");
  let lastRole = roleSelect ? roleSelect.value : 'agent';
  let pendingRole = null;
      // Auth modal handling: validate admin using ADMIN_KEY; agent requires no password
      if (roleSelect) {
        roleSelect.addEventListener("change", (e) => {
          const selectedRole = e.target.value;
          if (authError) authError.style.display = "none";
          if (authForm) authForm.reset();
          if (selectedRole === "admin" || selectedRole === "agent") {
            pendingRole = selectedRole;
            if (authModal) authModal.showModal();
          } else {
            // For inventory/service, switch role immediately and do not show modal
            lastRole = selectedRole;
            roleSelect.value = selectedRole;
            pendingRole = null;
          }
        });
      }

      // Handle Cancel button / closing the dialog (guard nulls)
      if (cancelBtn) {
        cancelBtn.addEventListener("click", (ev) => {
          ev.preventDefault();
          if (authModal) authModal.close(); // closes modal
          if (roleSelect) roleSelect.value = lastRole; // revert role
          pendingRole = null;
          if (authError) authError.style.display = "none";
        });
      }

      // Handle Login (use ADMIN_KEY for admin)
      if (authForm) {
        authForm.addEventListener("submit", (e) => {
          e.preventDefault();

          const password = document.getElementById("authPassword")?.value.trim() || '';

          if (!pendingRole) {
            if (authError) { authError.textContent = 'No role selected'; authError.style.display = 'block'; }
            return;
          }

          if (pendingRole === 'admin') {
            if (password !== (window.ADMIN_KEY || 'yahya123')) {
              if (authError) { authError.textContent = 'Invalid admin password!'; authError.style.display = 'block'; }
              if (roleSelect) roleSelect.value = lastRole;
              return;
            }
          }

          // success: accept agent or admin
          lastRole = pendingRole;
          if (roleSelect) roleSelect.value = pendingRole;
          pendingRole = null;
          if (authError) authError.style.display = 'none';
          if (authModal) authModal.close();
        });
      }

      // Optional: support Esc key to cancel (guard)
      if (authModal) {
        authModal.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            authModal.close("cancel");
          }
        });
      }

      // Register the Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((reg) => console.log("SW registered:", reg))
            .catch((err) => console.log("SW registration failed:", err));
        });
      }

      // PWA install prompt logic
      let deferredPrompt;
      const installBtn = document.getElementById("installPWA");

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        console.log("beforeinstallprompt fired!", e); // Prevent Chrome's default mini-infobar
        deferredPrompt = e; // Save the event
        installBtn.style.display = "block"; // Show your custom button
      });

      installBtn.addEventListener("click", () => {
        installBtn.style.display = "none";
        if (deferredPrompt) {
          console.log("User choice:", choice.outcome);
          deferredPrompt.prompt(); // Show install prompt
          deferredPrompt.userChoice.then((choiceResult) => {
            deferredPrompt = null; // Reset
          });
        }
      });

      // --- Manage Users (Admin only) ---
      const manageUsersBtn = document.getElementById('manageUsersBtn');
      const usersModal = document.getElementById('usersModal');
      const usersForm = document.getElementById('usersForm');
      const addUserBtn = document.getElementById('addUserBtn');
      const closeUsers = document.getElementById('closeUsers');
      const usersList = document.getElementById('usersList');

      function loadUsers() {
        try { return JSON.parse(localStorage.getItem('users') || '[]'); } catch { return []; }
      }
      function saveUsers(u) { localStorage.setItem('users', JSON.stringify(u)); }

      function renderUsers() {
        const users = loadUsers();
        if (!usersList) return;
        if (!users.length) {
          usersList.innerHTML = '<div class="muted">No users found. Use the form above to add users.</div>';
          return;
        }
        usersList.innerHTML = users.map((u, i) =>
          `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee">
            <div><strong>${escapeHtml(u.name)}</strong> <small class="muted">${escapeHtml(u.role)}</small></div>
            <div><button class="ghost delUserBtn" data-i="${i}">Delete</button></div>
          </div>`
        ).join('');
      }

      // small helper to avoid simple HTML injection
      function escapeHtml(s){
        return String(s||'').replace(/[&<>"']/g, function(c){
          return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
          })[c] || c;
        });
      }

      // Show Manage Users button only for admin users
      (function initManageUsersButton(){
        try {
          const current = JSON.parse(localStorage.getItem('auth.user')||'null');
          if (manageUsersBtn) manageUsersBtn.style.display = (current && current.role === 'admin') ? 'inline-block' : 'none';
        } catch(e) {
          if (manageUsersBtn) manageUsersBtn.style.display = 'none';
        }
      })();

      if (manageUsersBtn) {
        manageUsersBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          const current = JSON.parse(localStorage.getItem('auth.user')||'null');
          if (!current || current.role !== 'admin') return alert('Only admins can manage users');
          if (usersModal) usersModal.showModal();
          renderUsers();
        });
      }

      if (addUserBtn) {
        addUserBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          const name = document.getElementById('newUserName')?.value?.trim();
          const role = document.getElementById('newUserRole')?.value || 'agent';
          const pass = document.getElementById('newUserPass')?.value || '';
          if (!name) return alert('Name is required');
          const users = loadUsers();
          // prevent duplicate same-name+role
          const exists = users.find(u => u.name.toLowerCase() === name.toLowerCase() && u.role === role);
          if (exists) return alert('User with same name and role already exists');
          users.push({ name, role, pass });
          saveUsers(users);
          // clear inputs
          document.getElementById('newUserName').value = '';
          document.getElementById('newUserPass').value = '';
          document.getElementById('newUserRole').value = 'agent';
          renderUsers();
        });
      }

      if (closeUsers) {
        closeUsers.addEventListener('click', (ev) => {
          ev.preventDefault();
          if (usersModal) usersModal.close();
        });
      }

      // Delegate delete clicks
      if (usersList) {
        usersList.addEventListener('click', (ev) => {
          const btn = ev.target.closest('.delUserBtn');
          if (!btn) return;
          const idx = Number(btn.dataset.i);
          if (!Number.isFinite(idx)) return;
          const users = loadUsers();
          const u = users[idx];
          if (!u) return;
          if (!confirm(`Delete user ${u.name} (${u.role})?`)) return;
          users.splice(idx,1);
          saveUsers(users);
          renderUsers();
        });
      }
    </script>
  </body>
</html>
